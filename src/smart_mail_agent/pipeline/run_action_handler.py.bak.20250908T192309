from __future__ import annotations
import os, sys, subprocess, time
from pathlib import Path

def run_e2e_mail(eml_dir: str, out_dir: str, db_path: str = "db/sma.sqlite", ndjson_path: str = "reports_auto/logs/pipeline.ndjson"):
    """
    安全代理：避免匯入期的重依賴/連網副作用，暫時交由 legacy runner 執行。
    後續你要回復正式管線，再把這個代理換回真正實作即可。
    """
    root = Path(__file__).resolve().parents[3]
    py = sys.executable
    env = os.environ.copy()
    env.setdefault("SMA_ROOT", str(root))
    env.setdefault("SMA_RUN_TS", time.strftime("%Y%m%dT%H%M%S"))
    legacy = root / "scripts" / "sma_e2e_mail.py"
    if not legacy.exists():
        raise RuntimeError(f"legacy runner not found: {legacy}")
    # 目前 legacy runner 只吃 eml_dir；out_dir/db/ndjson 用現有預設
    cmd = [py, "-u", str(legacy), str(eml_dir)]
    subprocess.run(cmd, check=True, env=env)
